# Redis&Kafka를 활용한 선착순 쿠폰 이벤트 개발기

사용기술 스택 

- Kafka
- Redis

쿠폰

- 3000이상의 쿠폰
- 200k 장의 쿠폰 발행

기존의 쿠폰 시스템은 RDB에 의존하여서 진행이 되었다

내가 생각하는 쿠폰 TABLE

| 쿠폰 종류 | coupon_type |
| --- | --- |
| 쿠폰 수량 | count |
|  |  |

RDB에서 하면 count를 수정하면서 lock 걸리고 동시성 이슈가 있다 쿠폰이 만 장 정도 있다고 하면 동시성 문제에서 불편함을 느끼고 시간이 지연 될 여지가 있다

### 선착순 이벤트 요구사항

1. 이벤트 기간 동안, 매일 특정 시간 오픈하며 총 지급 수량을 한정한다
2. 쿠폰의 지급 수량은 당일 정해진 양을 초과해서는 안된다
3. 쿠폰은 1인당 1장만 지급

Redis에 쿠폰 종류와 쿠폰 수량을 저장하고 불러와서 사용하면 동시성 문제에서 어느정도 속도 이슈를 해결할 수 있을 것 같다

> 레디시는 단일 스레드 기반 커맨드를 순차적으로 실행하고 결과를 전달하기 때문에 동시성 이슈가 해결된다고 생각헀다고함
> 

- 1,2 해결 → redis의 초기 데이터를 0으로 세팅하고 INCR 커맨드를 사용하여 1씩 증가시킴
- 3 해결 Redis Set 자료형을 사용하여 중복을 방지함

![Untitled](Untitled%204.png)

SCARD + SADD 까지 레디스 트랜잭션 처리를 함.

(레디스 롤백은 standalone redis에서만 롤백을 지원하고 cluster 레디스는 롤백을 지원하지 않음)

### Zero-Payload 방식

필요한 최소한의 데이터를 보내서 처리하는 것을 말한다. 이렇게 할 경우 다른 payload들이 변경되어도 id만 넘기고 있기에 변경에 강하다. (id 뿐만 아니라 호출해야하는 api 정보를 담기도함)